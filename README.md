# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Карточка товара

```
interface Iproduct {
    id: string;
    description: string;
    image: string;
    title: string;
    category: string;
    price: number | null;
    index?: number;
}
```

Покупатель

```
export interface Ibuyer {
    payment: 'online' | 'cash' | '';
    email: string;
    phone: string;
    address: string;
    total: number;
    items: string[];
}
```

Интерфейс для каталога карточек

```
interface ICatalog {
    catalog: Iproduct[];
}
```

Интерфейс модального окна

```
interface IModalData {
	content: HTMLElement;
}
```

Интерфейс состояния приложения

```
interface IState {
	validation?: boolean;
	errors?: string[];
}
```

Интерфейс страницы

```
interface IPage {
	counter: number;
	catalog: HTMLElement[];
	locked: boolean;
}
```

Интерфейс полей формы заказа

```
interface IOrderForm {
	address?: string;
	email: string;
	phone: string;
}
```

Интерфейс для состояния формы

```
interface IFormState {
	valid: boolean;
	errors: string[];
}
```

Тип для обработки ошибок формы

```
type FormErrors = Partial<Record<keyof Ibuyer, string>>;
```

Интерфейс успешного совершения заказа

```
interface ISuccess {
    total: number;
}
```

Интерфейс получения каталога карточек с сервера

```
interface ICatalogAPI {
    getCatalog: () => Promise<Iproduct[]>;
}
```

Интерфейс отправки заказа на сервер

```
interface IOrderResult {
	id: string;
	total: number;
}
```

Интерфейс корзины

```
interface IBasketView {
    items: HTMLElement[];
    total: number;
    selected: string[];
}
```

Интерфейс элемента корзины

```
interface IBasketItem {
	index: number;
	id: string;
	title: string;
	price: number;
}
```

Интерфейс пользовательского действия

```
interface IAction {
	onClick: (event: MouseEvent) => void;
}
```

## Архитектура приложения

Приложение построено по принципу разделения слоев MVP.
Слой данных работает только с данными, хранит и изменяет их. Слой отображения отвечает только за
отрисовку элементов на странице. Презентер играет роль связующего звена между слоем данных и слоем
отображения.

### Базовый код

#### Класс Api

Базовый класс Api отвечает за работу с сервером. Отправляет и получает запросы. В конструктор класса передается
адрес сервера и опционально объект с заголовками.
Методы:

- `get` - выполняет GET запрос и возвращает ответ сервера
- `post` - принимает объект с данными в формате JSON и отправляет эти данные на сервер. По умолчанию отправляется POST
  запрос, но если требуется другой метод, его тип можно передать третьим аргументом.

#### Класс EventEmitter

Клаcc представляет собой брокер событий. Позволяет подписываться на события и отправлять события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.

Основные методы, реализуемые классом, описаны интерфейсом `IEvents`:

- `on` - подписка на событие;
- `emit` - инициализация события;
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие.

### Слой данных (Model)


#### Класс Model

Абстрактный класс модели приложения, является дженериком и родителем класса, отвечающего за состояние приложения.
В конструктор класса передаются объект с данными и объект с событиями приложения. Единственный метод `emitChanges` сообщает, что модель
изменилась.

#### Класс AppState

Отвечает за состояние приложения: хранит все данные приложения, реализует бизнес-логику работы с корзиной, валидации форм, подсчета суммы. Уведомляет компоненты об изменении состояния системы. Наследует абстрактный класс Model. Свойство catalog представляет собой массив объектов вида Iproduct, т.е. массив товаров. Свойство buyer это объект вида Ibuyer, который содержит в себе всю информацию о покупателе. Свойство formErrors содержит информацию об ошибках формы.

В полях класса хранятся следующие данные:

- `catalog` - список товаров (массив объектов товаров);
- `basket` - товары в корзине;
- `order` - данные заказа;

Методы:

- `setCatalog` служит для изменения каталога товаров при загрузке с сервера и оповещает всех об изменении каталога;
- `toggleOrderItem` добавляет или удаляет товар из корзины;
- `validate` обеспечивает валидацию формы заказа;
- `validateContacts` обеспечивает валидацию формы контактов;
- `getTotal` возвращает итоговую сумму заказа;
- `clearBasket` очищает корзину и сбрасывает поля заказа;
- `getCards` возвращает массив товаров, находящихся в корзине;
- `isFilledFieldsOrder` проверяет, все ли поля заполнены;
- `setField` устанавливает значение поля и запускает валидацию;
- `setPaymentMethod` устанавливает способ оплаты;
- `clearOrderFields` очищает все поля.

#### Класс CatalogAPI

Отвечает за взаимодействие с сервером. Получает данные товаров и отправляет информацию о заказе. Наследует базовый класс Api. В конструкторе принимает базовый адрес сервера и опционально настройки.

Методы:

- `getProduct` получает данные товара по его id;
- `getCatalog` получает каталог товаров;
- `orderDone` отправляет данные заказа на сервер.

### Cлой отображения (View)
Все классы отображения отвечают за отображение внутри контейнера (DOM-элемента) передаваемых в них данных.

#### Класс Component

Абстрактный класс, на основе которого создаются компоненты приложения. Является дженериком и родителем всех компонентов слоя отображения. Класс включает в себя основные инструменты для работы с DOM-элементами. Наследуется всеми классами, отвечающими за отображение. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Метод render отвечает за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

Методы:

- `toggleClass` - переключает класс элемента;
- `setText`- устанавливает текстовое содержимое элемента;
- `setImage`- устанавливает изображение и альтернативный текст;
- `setDisabled` - изменяет статус блокировки элемента;
- `setHidden` , `setVisible` - скрывает/отображает элемент;
- `render` - отрисовывает компонент.

#### Класс Page

Класс отвечает за главный контейнер приложения, основную страницу. Наследует абстрактный класс Component. Конструктор класса принимает контейнер и экземпляр класса событий для возможности инициации событий. В конструкторе установлен слушатель на открытие корзины.

Внутри класса доступны данные:

- `_catalog` - контейнер для каталога товаров;
- `_counter` - контейнер для счетчика товаров в корзине;
- `_wrapper` - обертка;
- `_basket` - контейнер для кнопки корзины.

Сеттеры:

- `counter` - устанавливает значение счетчика товаров;
- `catalog` - устанавливает содержимое каталога на страницу;
- `locked` - блокирует/разблокирует прокрутку;

#### Класс Modal

Класс отвечает за работу модальных окон. Наследует абстрактный класс Component. В конструктор передается контейнер и экземпляр класса событий. В конструкторе класса устанавливаются слушатели на все интерактивные элементы модального окна.

Внутри класса доступны данные:

- `_closeButton` - кнопка закрытия модального окна;
- `_content` - контейнер для содержимого.

Метод `open` открывает модальное окно, метод `close` - закрывает. Метод `render` переопределяется, здесь он открывает модальное окно после отрисовки. Сеттер `content` устанавливает содержимое внутри модального окна.

#### Класс Form

Класс для работы с формами. Наследует абстрактный класс Component. В конструкторе класса установлены слушатели на события ввода и отправки формы.

Внутри класса доступны:

- `_submit` - кнопка сабмита;
- `_errors` - контейнер для текстового содержимого ошибок формы.

Методы:

- `onInputChange` - обработчик изменения полей формы;
- `render` отвечает за отрисовку элемента формы.

Сеттер `valid` устанавливает значение валидности формы и отвечает за активность/неактивность кнопки, `errors` устанавливает текст ошибки.

#### Класс Order

Класс отвечает за работу с темплейтом формы заказа. Наследует класс Form. Реализует логику обработки данных заказа, включая выбор способа оплаты и ввод адреса доставки.

Внутри класса доступны:

- `_btnCash` - кнопка выбора оплаты наличными;
- `_btnCard` - кнопка выбора онлайн оплаты.

Метод `paymentChange` обрабатывает изменение способа оплаты.
Сеттер `address` устанавливает значение поля адреса, сеттер `payment` устанавливает выбранный способ оплаты и меняет активность кнопок.

#### Класс Contacts

Класс отвечает за работу с формой контактов. Конструктор и основные методы работы с формой наследуются, класс содержит лишь уникальные сеттеры: `phone` для установки телефона покупателя и `email` для установки адреса электронной почты.

#### Класс Success

Класс отвечает за отображение модального окна успешного оформления заказа. В конструкторе устанавливается слушатель на кнопку закрытия модального окна.

Внутри класса доступны:

- `_close` - кнопка закрытия окна;
- `_total` - контейнер для отображения списания итоговой суммы заказа.
  Сеттер `total` устанавливает итоговую сумму с правильным склонением.

#### Класс Card

Класс отвечает за работу с данными карточки товара. Наследует класс Component. В конструктор класса передается DOM элемент темплейта, что позволяет при необходимости формировать карточки разных вариантов верстки. В классе устанавливается слушатель на кнопку "Купить". Собственных методов у класса нет, методы наследуются от родительского класса Component.

Свойства, доступные внутри класса:

- `_title` - элемент заголовка карточки;
- `_price` - элемент цены карточки;
- `_image` - элемент картинки карточки;
- `_category` - элемент категории карточки;
- `_description` - элемент описания карточки;
- `_buttonModal` - элемент кнопки карточки.

Сеттеры:

- `id` - изменяет значение id карточки;
- `title` - изменяет название карточки;
- `description` - изменяет описание карточки;
- `category` - изменяет категорию;
- `price` - изменяет цену.

Геттеры:

- `id` - возвращает id карточки;
- `title` - возвращает название карточки.

#### Класс Basket

Класс отвечает за работу с данными корзины. Наследует класс Component. Конструктор класса помимо контейнера корзины принимает экземпляр `EventEmitter` для инициации событий. В конструкторе класса устанавливается слушатель на кнопку "Оформить".

Внутри класса доступны:

- `_list` - список товаров в корзине;
- `_total` - общая сумма товаров в корзине;
- `_button` - кнопка "Оформить".

Сеттеры:

- `items` - изменяет список добавленных в корзину товаров, если таковые имеются, иначе создает на его месте текст "Корзина пуста";
- `selected` - изменяет состояние кнопки в зависимости от списка добавленных товаров;
- `total` - изменяет общую сумму товаров в контейнере суммы.

#### Класс BasketItem

Класс отвечает за работу с элементом списка корзины. Наследуется от класса Component. Конструктор принимает контейнер элемента корзины, в конструкторе класса устанавливается слушатель на кнопку удаления товара.

Внутри класса доступны:

- `_index` - количество товаров в корзине;
- `_title` - название товара;
- `_price` - цена товара;
- `_buttonDelete` - кнопка удаления товара;

Сеттер `index` устанавливает количество товаров в корзине, `title` - название товара, `price` - цену, `id` - id  товара.
Геттер `id` возвращает id товара.

### Слой презентера

Взаимодействие представления и данных происходит в файле `index.ts`, выполняющем роль презентера. Презентер реализован как набор обработчиков событий. Сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий. Таким образом выполняется разделение ответственности между слоями.

Основные события приложения:

- `items:changed` - изменение каталога товаров;
- `card:select` - выбор карточки товара;
- `basket:open` - открытие корзины;
- `basket:changed` - изменение содержимого корзины;
- `order:open` - открытие формы заказа;
- `order:submit` - отправка формы заказа;
- `order.payment:change` - изменение способа оплаты;
- `order.address:change` - изменение адреса доставки;
- `contacts.email:change` - изменение email;
- `contacts.phone:change` - изменение телефона;
- `contacts:open` - открытие формы контактов;
- `contacts:submit` - отправка формы контактов;
- `modal:open`- открытие модального окна;
- `modal:close` - закрытие модального окна;
- `form:errors` - ошибки валидации форм.
